<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>US Map</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f8fafc;
        }

        #map-container {
            width: 100vw;
            height: 100vh;
            background: #f1f5f9;
            cursor: grab;
        }

        #map-container:active {
            cursor: grabbing;
        }

        .state {
            stroke: #fff;
            stroke-width: 0.5px;
        }

        .tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            pointer-events: none;
            font-size: 0.875rem;
            opacity: 0;
        }

        .zoom-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }

        .zoom-button {
            padding: 10px 16px;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 100px;
        }

        .zoom-button:hover {
            background: #f8fafc;
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="tooltip" class="tooltip"></div>
        <div class="zoom-controls">
            <button id="zoom-in-button" class="zoom-button">Zoom In +</button>
            <button id="zoom-out-button" class="zoom-button">Zoom Out âˆ’</button>
            <button id="reset-button" class="zoom-button">Reset</button>
        </div>
    </div>

    <script>
        async function init() {
            const container = document.getElementById('map-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            const svg = d3.select("#map-container")
                .append("svg")
                .attr("width", width)
                .attr("height", height);

            const g = svg.append("g");

            const initialTransform = d3.zoomIdentity;
            
            const zoom = d3.zoom()
                .scaleExtent([0.5, 20])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });

            svg.call(zoom)
                .on("dblclick.zoom", null);

            document.getElementById("zoom-in-button").addEventListener("click", () => {
                svg.transition()
                    .duration(200)
                    .call(zoom.scaleBy, 1.5);
            });

            document.getElementById("zoom-out-button").addEventListener("click", () => {
                svg.transition()
                    .duration(200)
                    .call(zoom.scaleBy, 1 / 1.5);
            });

            document.getElementById("reset-button").addEventListener("click", () => {
                svg.transition()
                    .duration(750)
                    .call(zoom.transform, initialTransform);
            });

            try {
                let districts;
                let legislators;
                
                // Load 2024 GeoJSON (converted from shapefile)
                try {
                    districts = await d3.json("districts-2024-optimized.geojson");
                    console.log("Loaded 2024 optimized GeoJSON with", districts.features.length, "features");
                } catch (error) {
                    console.warn("Failed to load optimized GeoJSON, trying full version:", error);
                    try {
                        districts = await d3.json("districts-2024.geojson");
                        console.log("Loaded 2024 GeoJSON with", districts.features.length, "features");
                    } catch (error2) {
                        console.warn("Failed to load 2024 GeoJSON, falling back to 2010:", error2);
                        districts = await d3.json("gz_2010_us_500_11_20m.json");
                        console.log("Loaded 2010 GeoJSON with", districts.features.length, "features");
                    }
                }
                
                legislators = await d3.json("legislators-current.json");

                const fipsToState = {
                    "01": "AL", "02": "AK", "04": "AZ", "05": "AR", "06": "CA", "08": "CO", "09": "CT",
                    "10": "DE", "11": "DC", "12": "FL", "13": "GA", "15": "HI", "16": "ID", "17": "IL",
                    "18": "IN", "19": "IA", "20": "KS", "21": "KY", "22": "LA", "23": "ME", "24": "MD",
                    "25": "MA", "26": "MI", "27": "MN", "28": "MS", "29": "MO", "30": "MT", "31": "NE",
                    "32": "NV", "33": "NH", "34": "NJ", "35": "NM", "36": "NY", "37": "NC", "38": "ND",
                    "39": "OH", "40": "OK", "41": "OR", "42": "PA", "44": "RI", "45": "SC", "46": "SD",
                    "47": "TN", "48": "TX", "49": "UT", "50": "VT", "51": "VA", "53": "WA", "54": "WV",
                    "55": "WI", "56": "WY"
                };

                const legislatorMap = new Map();
                legislators.forEach(leg => {
                    const term = leg.terms[leg.terms.length - 1];
                    if (term.type === 'rep' && term.district !== undefined) {
                        const key = `${term.state}-${term.district}`;
                        legislatorMap.set(key, {
                            name: leg.name.official_full || `${leg.name.first} ${leg.name.last}`,
                            party: term.party
                        });
                    }
                });
                
                console.log(`Loaded ${legislatorMap.size} representatives`);

                const projection = d3.geoAlbersUsa()
                    .fitSize([width, height], districts);

                const path = d3.geoPath().projection(projection);

                const getPartyColor = (party) => {
                    if (!party) return "#94a3b8"; // gray for unknown
                    const partyLower = party.toLowerCase();
                    if (partyLower.includes("republican")) return "#dc2626"; // red
                    if (partyLower.includes("democrat")) return "#2563eb"; // blue
                    return "#94a3b8"; // gray for other parties
                };

                g.selectAll("path")
                    .data(districts.features)
                    .enter()
                    .append("path")
                    .attr("class", "state")
                    .attr("d", path)
                    .attr("fill", (d) => {
                        const props = d.properties || {};
                        const stateFips = props.STATEFP || props.STATE;
                        const districtNum = parseInt(props.CD119FP || props.CD118FP || props.CD || props.CD118 || props.CD119);
                        const stateAbbr = fipsToState[stateFips];
                        
                        if (stateAbbr && !isNaN(districtNum)) {
                            const key = `${stateAbbr}-${districtNum}`;
                            const legislator = legislatorMap.get(key);
                            if (legislator) {
                                return getPartyColor(legislator.party);
                            }
                        }
                        return "#94a3b8"; // gray for districts without legislator data
                    })
                    .on("mouseover", (event, d) => {
                        const originalFill = d3.select(event.currentTarget).attr("fill");
                        d3.select(event.currentTarget).attr("fill", d3.rgb(originalFill).darker(0.5));
                        
                        const tooltip = document.getElementById("tooltip");
                        const props = d.properties || {};
                        const stateFips = props.STATEFP || props.STATE;
                        const districtNum = parseInt(props.CD119FP || props.CD118FP || props.CD || props.CD118 || props.CD119);
                        const stateAbbr = fipsToState[stateFips];
                        
                        let tooltipText = `${stateAbbr}-${districtNum}`;
                        if (stateAbbr && districtNum !== undefined) {
                            const key = `${stateAbbr}-${districtNum}`;
                            const legislator = legislatorMap.get(key);
                            if (legislator) {
                                tooltipText = `${legislator.name}\n${stateAbbr}-${districtNum} (${legislator.party})`;
                            } else {
                                tooltipText = `${stateAbbr}-${districtNum}`;
                            }
                        }
                        
                        tooltip.textContent = tooltipText;
                        tooltip.style.opacity = 1;
                        tooltip.style.left = (event.pageX + 10) + "px";
                        tooltip.style.top = (event.pageY + 10) + "px";
                    })
                    .on("mousemove", (event) => {
                        const tooltip = document.getElementById("tooltip");
                        tooltip.style.left = (event.pageX + 10) + "px";
                        tooltip.style.top = (event.pageY + 10) + "px";
                    })
                    .on("mouseout", (event, d) => {
                        const props = d.properties || {};
                        const stateFips = props.STATEFP || props.STATE;
                        const districtNum = parseInt(props.CD119FP || props.CD118FP || props.CD || props.CD118 || props.CD119);
                        const stateAbbr = fipsToState[stateFips];
                        
                        let fillColor = "#94a3b8";
                        if (stateAbbr && districtNum !== undefined) {
                            const key = `${stateAbbr}-${districtNum}`;
                            const legislator = legislatorMap.get(key);
                            if (legislator) {
                                fillColor = getPartyColor(legislator.party);
                            }
                        }
                        
                        d3.select(event.currentTarget).attr("fill", fillColor);
                        document.getElementById("tooltip").style.opacity = 0;
                    });

            } catch (error) {
                console.error("Error loading map:", error);
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", height / 2)
                    .attr("text-anchor", "middle")
                    .text("Error loading map");
            }
        }

        init();
    </script>
</body>
</html>
